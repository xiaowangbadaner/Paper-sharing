# 单细胞RNA插补综述

> 文章地址https://zhuanlan.zhihu.com/p/108918012
>
> 研究案例https://github.com/theislab/single-cell-tutoria

## 框架

* `Scanpy`  https://scanpy.readthedocs.io/en/stable/tutorials.html

## 知识清单

* `Gene count`矩阵
* 分子计数矩阵（`count matrix`）
* `reads count` （读数矩阵）
* `QC`指标、`QC`分布、`QC`变量、`FASTQC`
* `t-SNE`

## 预处理和可视化

* 原始测序数据——>分子计数矩阵（`count matrix`）/`reads count` （读数矩阵）  *取决于是否包含唯一分子标识符（`UMI`， `unique molecular identifiers`）*

* 原数据处理流程：`Cell Ranger`、`indrops`、`SEQC`、`zUMIs`负责测序数据质控，确定`reads`来源的细胞 (`barcodes`) 和`mRNA`分子 、基因组比对和定量。获得的`reads`或`count`矩阵的行数等于`barcodes`的数目，列数等于基因数目。`count data`比`reads data`噪声更低。

* 生物样品到单细胞数据需要多步实验操作。典型的工作流程包含单细胞解离、单细胞分离、文库构建和测序。

* 两种解离方式：

  - 基于平板的技术将细胞分到到板上的孔中。
  - 基于液滴的方法则依赖于微流体液滴捕获单个细胞（常见空滴液）

  两种方式均会出现多个细胞一起被捕获（`doublets or multiplets`）、非活细胞被捕获或根本没有细胞被捕获（`空液滴/孔`）等问题。

* 文库构建包括捕获细胞内`mRNA`、反转录为`cDNA`分子并进行扩增等过程。文库构建时每个细胞是独立的。
* 一般在测序之前需要先扩增细胞`cDNA`以增加其被检测的可能性。但微量扩增更容易引入`PCR`偏好性。`UMI`使我们能够区分测到的`reads`是来源于mRNA分子的不同`扩增拷贝`还是来源于`独立的mRNA分子`，从而可以进行更准确的定量。
* 每个细胞单独构建的cDNA文库都带有`cell barcode`和/或`UMI`（取决于protocol）。

## 质控

* 在分析单细胞基因表达数据之前，为确保所有的` barcode`都对应于有效细胞 (`viable cells`，有活力的细胞)。质控有3个指标：（检查这`3`个指标的分布中**是否存在异常峰并设置阈值去除**，异常可能对应于死细胞、细胞膜破损的细胞或`doublets`）
  * 测到的转录本分子总数
  * 测到的基因总数
  * 来源于线粒体基因的转录本所占比例
* 不同类型细胞混合体的数据集的每个QC指标可能会呈现多个分布聚集峰。
* **阈值的选择应随待分析数据集中的细胞数量和既定的下游分析而定**。
* 可以直接对计数矩阵 (`count matrix`)执行进一步的质量控制。输入型基因表达（`Ambient gene expression`）是指某个`barcode`检测到的转录本是源自其他细胞在建库前发生破裂而释放到细胞悬液中的`mRNA`。这些增加的外来计数会影响下游分析。
* 质控是用于保证下游分析时数据质量足够好。在分析数据时需要**反复**调整参数进行质量控制 (*反复分析，多次分析，是做生信的基本要求*)。**从宽松的QC阈值开始并研究这些阈值的影响，然后再执行更严格的QC，通常是有益的**。
* 通过可视化检测到的基因数量、总分子数和线粒体基因的表达比例的分布中的异常峰来执行QC。联合考虑这3个变量，而不是单独考虑一个变量。
* 尽可能设置宽松的QC阈值；如果下游聚类无法解释时再重新设定严格的QC阈值。
* 如果样品之间的QC变量分布不同（存在多个强峰），则需要考虑样品质量差异，应按照`Plasschaert et al. (2018)`的方法为每个样品分别确定QC阈值。

## 标准化

* 计数矩阵中的每个数值代表细胞中一个mRNA分子被成功捕获、逆转录和测序。
* `Normalization`可以通过调整计数数据 (`scaling count data`)以获得细胞之间**可比的相对基因表达丰度**。
* 测序深度标准化，也称为“每百万计数”或`CPM normalization`。使用每个细胞的测序深度作为`size factor`对计数数据进行标准化。CPM标准化假设数据集中的所有细胞最初都包含相等数量的`mRNA`分子，并且计数深度差异来源于技术问题。（变体：把`size factor`放大`10^6`倍如CPM，或`size factor`乘以数据集中所有细胞的测序深度的中位数。）
* `downsampling`方法也基于同样的假设，从原始数据中随机抽取预设的`等量reads`以保证所有细胞测序深度相同。`downsampling`方法在扔掉一些数据的同时增加了`technical dropout rates`。因此`downsampling`方法可能更真实地反应了相同测序深度下不同细胞的表达谱特征。
* 软件包`Scran`的`pooling‐based size factor`方法对细胞异质性的影响处理更好。首先把细胞合并到一起避免`technical dropout`效应，然后基于基因表达的线性回归模型估算`size factor`。这一方法允许细胞有少于`50%`的差异表达基因。**scran比其他标准化方法对后续批次校正和差异表达分析效果更好**。
* `CPM`, `high‐count filtering CPM`和`scran` 使用线性全局缩放对计数数据进行标准化。非线性标准化方式：`Mayer et al` 使用技术相关协变量（例如测序深度和每个基因的计数）作为模型参数对`count data`拟合负二项模型。模型的残差作为标准化后的基因表达值。
* scRNA-seq技术可分为全长和`3'`富集方法。全长方案的数据可能会受益于考虑了基因长度的标准化方法，而`3'`富集测序数据则不然。`TPM`归一化是全长scRNA-seq数据常用的归一化方法，它来自bulk RNA-seq分析。
* 标准化是对细胞计数数据进行缩放处理以使其在细胞之间可比。
* 也可以在基因层面对基因计数进行归一化 (`scale`)以便于基因内部进行直接比较。基因归一化是指一个基因减去其在所有样品表达的均值然后除以其在所有样品表达值的标准差。归一化后，这个基因在所有样品表达值均值为`0`，用单位方差形式表示其表达值。归一化后，所有基因在下游分析时权重是一样的。（*归一化后，原始基因的表达丰度信息就没了，换成了无标度的标准差的表示。*）
* 标准化后，数据矩阵通常进行`log(x+1)`转换。此转换具有三个重要作用。
  - 首先，对数转换后的表达式值之间的差值可对应于对数转换后的倍数变化，这是衡量基因表达变化的常用方法。
  - 其次，对数转换可减轻（但不能消除）单细胞数据的均值-方差关系 (`mean-variance relationship`) （*均值-方差关系展示数据在特征空间的分布关系。方差越大数据分布越广，后续采用线性回归算法时效果越差。*）。
  - 最后，对数转换可以减少数据的偏态分布，从而使数据近似于正态分布，更符合许多下游分析工具对数据分布的假设要求。

## 数据校正和整合

* 标准化后的数据可能仍然包含有与研究不相干的因素带来的影响。数据校正的目的就是进一步去除技术因素和非关注的生物学混杂因素，例如批次、`dropout`或细胞周期不同带来的影响。
* **混淆因素并不总是需要校正。**
* 我们建议分别考虑对生物学和技术混杂因素 (`covariates`)的校正。
* 校正的话，所有因素同时校正而不是分别校正技术和非关注的生物因素变量。
* 基于板的数据集预处理时需要校正`count`数的影响，建议采用非线性标准化方法或`downsampling`方法进行标准化。
* 当批次之间的细胞类型和状态组成一致时，建议通过`ComBat`执行批次校正。
* 数据整合和批次校正应通过不同的方法进行。数据整合工具可能会过度校正简单的批次效应。
* 用户需要对只在缺失值填充后才能发现的信号格外注意。探索性分析时最好不进行缺失值填充操作。
* 仅在进行轨迹推断和校正的生物学混杂因素不影响感兴趣的生物学过程时才校正这些因素的影响。

### 去除与研究不相干的生物因素的影响

* 对不关注的生物学因素的校正可用来挑选出**特定的感兴趣的目标生物学信息**。

* 消除细胞周期：使用`Scanpy`和`Seurat`对每个细胞的细胞周期评分进行简单的线性回归校正或通过应用了更复杂的混合模型的专用程序包如`scLVM`或`f-scLVM`进行校正。

### 去除技术影响

* 用于移除不相干生物因素影响的回归模型也可应用于校正实验技术因素的影响。单细胞数据中最突出的技术影响因素是测序深度和批次。

* 对测序深度进行回归校正可以提高轨迹推断算法的性能，该算法依赖于查找细胞之间的过渡。在校正多个协变量（干扰因素）（例如细胞周期和测序深度）时，应在单个步骤中对所有协变量（干扰因素）执行回归，以解决协变量（干扰因素）之间的依赖性。
* 消除测序深度影响的另一个策略是使用更严格的标准化程序，例如`downsampling`或非线性归一化方法。

### 批次效应和数据整合

* 批次效应：将细胞分组操作时可能会带来批次效应。

* 数据整合：整合来自多个实验的数据。

* 通常批次效应校正使用线性方法，而非线性方法则用于数据整合。

* 批次校正的最佳方法是通过**巧妙的实验设计来避免存在不同批次**。通过合并不同实验条件和样品的细胞一起进行后续操作可以避免批次效应。
* 数据整合面临的另一个挑战是数据集之间的组成差异 (`compositional differences`)
* 数据整合方法：典型相关分析（`Canonical Correlation Analysis`, `CCA`），相互最近邻（`Mutual Nearest Neighbours`, `MNN`), `Scanorama`, `RISC`, `scGen`, `LIGER`, `BBKNN`和`Harmony`。

### 缺失值填充

* 技术数据校正的另一种类型是缺失值填充（也称为降噪或插补, `denoising or imputation`）。
* 单细胞转录组的数据包含各种噪声。这种噪音的一个特别突出的来源是`dropout`。推断`dropouts`事件，用推断出的合适的表达值替换这些零以减少数据集中的噪声成为几种最新工具的目标 (`MAGIC`, `DCA`, `scVI`, `SAVE`, `scImpute`)。
* **需要基于原始计数矩阵进行操作。**

## 特征选择、降维和可视化

- 我们建议根据数据集的复杂程度选择`1,000`至`5,000`个高可变基因 (`HVG`)。
- 当将基因表达值归一化为均值为0和单位方差时，或者将模型拟合的残差用作标准化表达值时，不能使用基于基因表达均-方差的特征选择方法。因此，**在选择HVG之前，必须考虑要执行哪些预处理。**
- 信息汇总 (`summarization`，类比于挑选重要的主成分)和可视化应使用不同的降维方法。
- 我们建议使用`UMAP`进行探索性分析可视化；使用`PCA`做为通用数据降维方法；`diffusion maps`可以在轨迹推断时替代`PCA`。
- `UMAP+PAGA`是可视化特别复杂的数据集的合适替代方法。

### 特征选择

scRNA-seq数据集降维的第一步

* 对数据集基因进行过滤仅保留对数据的变异性**具有信息贡献**的基因（在数据中变异大的基因）。这些基因通常被定义为高变化基因（`HVG`，`highly variable genes`）。
* 在`Scanpy`和`Seurat`中，基因按其均值表达进行分组，将每个组内**方差/均值比**最高的基因选为每个分组的`HVG`。

### 降维

特征选择后，可以通过专用的降维算法进一步对单细胞表达矩阵进行降维。

* 将表达式矩阵映射到低维空间中，同时以尽可能少的维数捕获数据中所有的信息。
* 鉴于单细胞RNA测序数据固有的低维性特征，这一方法是合适的。也就是说，细胞表达图谱构成的生物形态 (`biological manifold`)可以使用远少于基因数目的维度信息来展示。
* 降维有两个主要目标：可视化和信息汇总（`summarization`）
  * 可视化是尝试在二维或三维空间最优地展示数据集。降维后的维度值就是数据在新的空间进行可视化如绘制散点图时的坐标值。
  * 汇总技术可通过计算数据的固有维数来将数据降维到基本组成（主）成分。信息汇总没有规定输出的维数；但更高的维数对表示原有数据的差异越来越不重要（*可以理解为PCA中各个主成分对于原始数据差异的解释依次降低*）。
* 常用主成分分析（PCA）和`diffusion maps`两种降维方法
  * 主成分分析是一种线性方法，通过最大化每个可能维度中捕获的残差 (`residual variance`)来进行降维。但通常用作非线性降维方法的预处理步骤。
  * `diffusion map`是一种非线性数据降维技术。由于`diffusion component`强调数据的转换，因此主要用于诸如细胞分化之类的连续过程。通常，每个`diffusion component`（即`diffusion map 维度`）突出显示不同细胞群体的异质性。

### 可视化

* 可视化时一般使用非线性降维方法。scRNA-seq数据可视化的最常见的降维方法是`t‐SNE` （ `t‐distributed stochastic neighbour embedding`）。t‐SNE的维度着重于以牺牲全局结构为代价来保留局部相似性 (*PCA则是尽可能多的保留全局差异*)。

* `t‐SNE`的常见替代方法是`UMAP` (*Uniform Approximation and Projection method*)或基于图的工具。
* `UMAP`与众不同的是它的速度快和能应用于更大规模数据的能力。因此，在没有特定生物学问题限制的情况下，我们将**UMAP视为探索性数据可视化分析的最佳实践**。
* 在细胞水平上经典可视化方法的替代方法是** `PAGA` (*partition‐based graph abstraction*）。**

## 数据预处理

* 预处理五个数据处理阶段：（i）原始数据，（ii）标准化后的数据，（iii）校正后的数据，（iv）特征选择后的数据，（v）降维后的数据。

* 数据处理的这些阶段可以归类为三个预处理层：测量的数据，校正的数据和降维的数据。
  * 测量的数据：原始数据和处理后但保留了表达值为零的基因的数据。应用细胞特异的`size factor`的全局标准化方法即使在`log(x+1)`转换后仍保留零表达值。
  * 校正后的数据会去除不需要的变化信息进而替换零表达值。校正后的数据层表示数据的“最干净”版本，它是数据代表的生物信号的最近似值。
  * 最终预处理层为降维后的数据（`reduced data`）。此数据层强调数据的主要差异，可以使用降维后的特征集来描述。 应用于后续的探索性方法（如可视化、邻域图推断、聚类）以及计算复杂的下游分析工具（如轨迹推断）
  * 虽然对生物协变量的校正可能会增加特定生物信号的强度，但其对潜在的生物学意义表示可能不甚准确，并且会掩盖可能相关的其他生物信号。因此，经过生物学不相关因素校正的数据主要适用于专注于特定生物学过程（例如轨迹推断方法）的分析工具。
  * 小结
    * 原始测量的数据用于差异基因统计检验分析；
    * 校正后的数据用于数据的可视化比较；
    * 降维后的数据用于其他基于数据形态（`biological data manifold`）的下游分析。
* 基因表达的统计比较需要基于测量数据层。使用测量的数据时，可以并且应该在差异统计分析模型中考虑技术协变量。

## 下游分析

* 经过预处理后，我们称之为下游分析的方法指应用于生物学发现并描述潜在的生物学系统的方法。通过将可以解释的模型拟合到数据中获得相应的结论。
* 下游分析可分为细胞水平和基因水平的方法。
* 细胞水平分析通常着重于两种结构的描述：簇和轨迹。这些结构又可以在细胞和基因水平上进行分析，即簇分析和轨迹分析方法。
* 簇分析方法试图将细胞分类为离散的多个组来解释数据的异质性。轨迹分析中，数据被视为细胞连续变化动态过程的一个个快照，轨迹分析方法研究了这一连续变化过程。

### 聚类分析

将细胞聚类成簇，可以推断成员细胞的身份。簇是通过基于细胞基因表达谱的相似性将细胞分组得到的。表达谱相似性是通过对将降维的数据进行距离度量确定的。相似性评分的一个常见示例是在主成分降维后的表达空间上计算的*欧氏距离*。两种根据这些相似性分数生成细胞簇的方法：*聚类算法*和*基于图的社群检测方法* （`community detection methods`）。

* 流行的k均值聚类算法。
* 使用社群检测方法检测图中的紧密连接区域。
* `PhenoGraph`方法（`Levine et al.，2015`）。在此之后，聚类单细胞数据集的标准方法已演变成多分辨率模块优化算法 (`multi‐resolution modularity optimization`），在单细胞KNN图中应用`Louvain`算法。
* `Louvin`算法将组内细胞连接数高于预期的一组细胞视作一个簇。(*Louvain algorithm算法采用迭代方式，先计算每个点加入到其邻居节点所在社区带来的模块性评估收益，然后将其加入收益最大的邻居节点所在社区，对所有未归类点重复进行这一过程，直至结果稳定。然后再把每个社区作为一个节点，重复上一步。*) 

### 细胞簇注释

* 在基因水平上，对每个簇的分析是鉴定其标记基因 (`Marker genes`)。这些所谓的标记基因代表了细胞簇的特征。
* 最好使用术语`cell identities`而不是`cell types`。在对细胞进行聚类和注释之前，用户必须确定要注释到的细胞信息精确水平，从而确定合适的聚簇分辨率。
* 两种方法可以使用参考数据库信息注释细胞簇：
  * 使用计算出的Marker基因或使用完整的基因表达谱。
  * 可以通过对目标簇的细胞和数据集中的所有其他细胞进行差异表达（DE）分析来鉴定标记基因集。
* 差异基因检测的零假设（`null hypothesis`）是两组细胞整体基因的表达值具有相同的分布。
* 当改为通过单个基因的表达确定细胞簇的身份时，`P`值可以解释为相对于其他基因的期望值。
* 不要使用标记基因的P-value值来验证细胞簇身份，尤其是当检测到的标记基因无益于注释细胞簇时。P值可能会被夸大。
* 请注意，由于数据集的细胞类型和状态组成，同一细胞簇的标记基因可能在数据集之间有所不同。
* 如果存在相关的参考数据集，我们建议综合使用自动聚类注释和基于数据的标记基因的手动注释来注释细胞类型。

### 细胞组成分析*

* 在细胞层面，我们可以根据其组成结构分析聚类数据。细胞组成数据分析围绕不同样品落入每个细胞簇的细胞比例进行分析。
* 在没有专用工具的情况下，细胞构成数据的可视化展示会给不同样品之间细胞组成变化提供有用的信息。
* 统计检验分析时需要考虑到样本之间的细胞簇比例的变化是互相依赖的（非独立的）。

### 轨迹推断

* 在典型的分析流程中，轨迹推断（TI）方法应用于降维后的数据

* 细胞多样性不能通过离散的分类系统（例如细胞聚类）充分描述。驱动观察到的细胞异质性发展的生物进程是一个连续过程（`Tanay＆Regev，2017`）。

* 为了捕获细胞身份之间的过渡状态、不同的分化分支或生物学功能的渐进式非同步变化，我们需要动态的基因表达模型。这类方法称为`轨迹推断`（`trajectory inference`，**TI**）。
* 轨迹推断方法通过最小化相邻细胞之间的转录改变构建细胞空间的转换路径。
* TI方法的差别在于**构建的发育轨迹模型拓扑结构复杂性不同**，从简单的线性轨迹或二分支轨迹到复杂树形轨迹、多分支轨迹或组合多种拓扑结构轨迹。（[NBT|45种单细胞轨迹推断方法比较，110个实际数据集和229个合成数据集](https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s%3F__biz%3DMzI5MTcwNjA4NQ%3D%3D%26mid%3D2247489863%26idx%3D1%26sn%3D17245a6dc0dbfb79442f98b9b693a092%26scene%3D21%23wechat_redirect)）
* 应使用多种方法来确定评估推断出的轨迹，以避免方法偏差。
* 在整个伪时间范围内连续平稳变化的基因是决定轨迹的关键基因，可用于识别潜在的生物学过程。

### 基因表达动力学*

* 通过将基因表达与伪时间 (`pusedotime`)信息进行回归来鉴定随轨迹显著变化的基因。
* 回归框架的区别有两点：一是其假设的噪声模型不同，二是构建的表达-伪时间函数的类别不同。

### 亚稳态

轨迹的细胞水平分析是指研究伪时间轴上的细胞密度。假设以无偏方式对细胞进行随机采样，轨迹中细胞密集的区域表示优选的转录状态。当将轨迹解释为时间过程时，这些密集区域可能代表例如发育中的亚稳态（`Haghverdi et al., 2016`）。我们可以通过绘制伪时间坐标的直方图来找到这些亚稳态。

### 细胞水平联合分析

聚类和轨迹推断代表单细胞数据的两个不同视角，用点代表单细胞簇，轨迹作为簇之间相连的边，可以同时展示数据的静态和动态属性。`PAGA`提出一个统计模型进行细胞簇互作分析，将细胞相似度高于期望值的两个簇之间用线连接。`PAGA`是唯一一个讨论到的可以处理不相连的拓扑结构和包含环形结构的复杂轨迹图的一个工具。

### 基因水平分析

到目前为止，虽然我们专注于表征细胞结构的基因水平分析方法，但是单细胞数据的基因水平分析有更广泛的内容。差异表达分析、基因集分析和基因调控网络分析都可以直接研究数据中的分子信号。这些方法不是描述细胞异质性，而是把这种异质性作为理解基因表达差异的背景。

### 差异表达分析

* 表达数据分析的一个常见问题是两个实验条件之间是否有基因发生了差异表达。
* 普通转录组的差异基因分析方法解决的是少量样品中精确评估基因表达变化的问题，而单细胞数据中不存在这一问题。
* 单细胞数据包含特有的技术噪音如`dropout`和高细胞变异性 (`Hicks et al, 2017; Vallejos et al, 2017`)。这些影响因素在设计单细胞专用的差异分析方法时都要有考虑。
* 单细胞工具`MAST`被视作加权普通转录组差异分析工具的替代方法。`MAST`应用`hurdle model`消除`dropout`的影响，并构建基因表达相对于实验条件和技术协变量的变化模型。
* DE测试不应基于校正后的数据（去噪，批次校正等），而应基于原始测量数据并在模型中引入干扰协变量。

### 基因集分析

通过基因共有的特征对基因进行分组并检验这些特征在候补基因列表中的出现是否显著富集 (`overrepresented`)以便更好的解释结果。

### 基因调控网络

基因不是独立发挥作用的。相反，基因的表达水平是由与其他基因和小分子之间的复杂调控决定的。揭示这些调控作用是基因调控网络（GRN）推断方法的目标。基因调控网络推断是基于对基因共表达如相关性、互信息（`mutual information`）或回归模型分析进行测量（`Chen＆Mar，2018`）。

### 分析平台

目前可用的分析平台有基于`R`（McCarthy et al., 2017; Butler et al., 2018）或`Python`（Wolf et al., 2018）的命令行，或具有图形用户界面（GUI）的本地应用程序（Patel，2018; Scholz et al., 2018）或Web服务（Gardeux et al., 2017; Zhu et al., 2017）。

Zhu et al.（2017）和Zappia et al.（2018）对这些分析平台进行了综述。

## 结论与展望

* 特别受关注并且可能改变现有分析流程的两个开发方向是深度学习分析和单细胞多组学整合分析。

* 随着单细胞组学技术的进步，对组学分析流程开发的需求将会增长（`Tanay＆Regev，2017`）。
* [我们预计这种多组学分析流程将建立在我们为scRNA-seq分析奠定的基础上](https://link.zhihu.com/?target=http%3A//mp.weixin.qq.com/s%3F__biz%3DMzI5MTcwNjA4NQ%3D%3D%26mid%3D2247488371%26idx%3D2%26sn%3D386cd4ab370eaf188c0da84d91348cd8%26chksm%3Dec0dd6f9db7a5fefd6422dcc5e5a2c7c157970aa4b13da50e4d253d392eed9a6599266d1ae51%26scene%3D21%23wechat_redirect)





















